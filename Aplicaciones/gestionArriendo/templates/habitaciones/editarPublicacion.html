{% extends 'habitaciones/plantilla.html' %}
{% block contenido %}
<br>
<h1 class="text-center mt-4">Editar Publicación</h1>

<form action="/procesarEdicionPublicacion/" method="POST" enctype="multipart/form-data" class="container mt-4" id="frm_validar">
    {% csrf_token %}
    <input type="hidden" name="publicacion_id" value="{{ publicacion.id }}">
    <div class="mb-3">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" name="titulo" id="titulo" class="form-control" value="{{ publicacion.titulo }}">
    </div>

    <div class="mb-3">
        <label for="precio" class="form-label">Precio</label>
        <input name="precio" id="precio" class="form-control" value="{{ publicacion.precio|floatformat:'f' }}" type="number" step="0.01" min="0">
    </div>

    <div class="mb-3">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea name="descripcion" id="descripcion" class="form-control" rows="4" >{{ publicacion.descripcion }}</textarea>
    </div>

    <div class="mb-3">
        <label for="tipohabitacion" class="form-label">Tipo de habitación</label>
        <select name="tipohabitacion" id="tipohabitacion" class="form-select" >
            <option value="">---- Seleccione una opción ----</option>
            {% for tipo in tipos %}
                <option value="{{ tipo.id }}" {% if tipo.id == publicacion.tipohabitacion.id %}selected{% endif %}>
                    {{ tipo.nombre }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="latitud">Latitud</label>
        <input type="text" class="form-control" id="latitud" name="latitud" value="{{ publicacion.latitud }}" readonly>

        <label for="longitud" class="mt-2">Longitud</label>
        <input type="text" class="form-control" id="longitud" name="longitud" value="{{ publicacion.longitud }}" readonly>
    </div>

    <br><br>
    <div class="" id="mapa_cliente" style="border:1px solid black; height:300px; width:100%"></div>

    <!-- Mostrar imágenes existentes (opcional) -->
    <label class="mt-3">Imágenes actuales:</label>
    <div class="d-flex flex-wrap gap-2 mb-3">
        {% for foto in fotos %}
            <img src="{{ foto.imagen.url }}" style="width: 100px; height: 100px; object-fit: cover;" class="border rounded">
        {% endfor %}
    </div>

    <label for="imagenes">Agregar nuevas imágenes (opcional)</label>
    <div>
        <input id="imagenes" name="imagenes[]" type="file" multiple accept="image/*">
    </div>

    <br><br>

    <div class="text-end mt-3">
        <button type="submit" class="btn btn-success">Guardar Cambios</button> &nbsp;&nbsp;&nbsp;&nbsp;
        <a href="/misPublicaciones" class="btn btn-secondary">Cancelar</a>
    </div>

</form>

<script>
    function initMap() {
        var latitud = parseFloat("{{ publicacion.latitud }}");
        var longitud = parseFloat("{{ publicacion.longitud }}");
        var latitud_longitud = new google.maps.LatLng(latitud, longitud);

        var mapa = new google.maps.Map(
            document.getElementById('mapa_cliente'),
            {
                center: latitud_longitud,
                zoom: 15,  // Mayor zoom para precisión
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
        );

        var marcador = new google.maps.Marker({
            position: latitud_longitud,
            map: mapa,
            title: "Ubicación actual",
            draggable: true
        });

        google.maps.event.addListener(
            marcador,
            'dragend',
            function(event) {
                document.getElementById("latitud").value = this.getPosition().lat();
                document.getElementById("longitud").value = this.getPosition().lng();
            }
        );
    }
    // CARGAR SIEMPRE EL MAPA
    window.onload = function() {
        initMap();
    };    
</script>


<script>
    $("#imagenes").fileinput({
        language: "es",
        allowedFileExtensions: ["jpg", "jpeg", "png"],
        showCaption: false,
        dropZoneEnabled: true,
        showClose: false,
        maxFileCount: 5,
        browseClass: "btn btn-primary",
        msgPlaceholder: "Selecciona hasta 5 imágenes..."
    });
</script>
<script>
    $("#frm_validar").validate(
        {
            rules:{
                titulo:{
                    required: true,
                    minlength: 5,
                    maxlength: 100
                },
                precio:{
                    required: true,
                    min: 50,
                    max: 9000,
                    step: 0.01,
                    Number: true
                },
                descripcion:{
                    required: true,
                    minlength: 10,
                    maxlength: 500
                },
            },
            messages:{
                titulo:{
                    required: "El titulo es obligatorio",
                    minlength: "El titulo debe tener al menos 3 caracteres",
                    maxlength: "El titulo no puede tener más de 255 caracteres"
                },
                precio:{
                    required: "El precio es obligatorio",
                    min: "El precio debe ser mayor o igual a 50",
                    max: "El precio no puede ser mayor a 9000",
                    step: "El precio debe ser un número de 2 decimales",
                    Number: "Ingrese un número válido"
                },
                descripcion:{
                    required: "La descripción es obligatorio",
                    minlength: "La descripción debe tener al menos 10 caracteres",
                    maxlength: "La descripción no puede tener más de 500 caracteres"
                },
            }
        });
</script>

<br>
{% endblock %}